<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPAL è‚¡ç¥¨ç­–ç•¥ - çœŸå¯¦æ•¸æ“šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">OPAL <span class="text-blue-600">INVEST</span></h1>
                <p class="text-xs text-slate-400 font-medium uppercase tracking-widest mt-1">Real-time Financial Engine</p>
            </div>
            <div id="connection-status" class="text-[10px] bg-emerald-100 text-emerald-600 px-2 py-1 rounded-full font-bold">
                â— API å·²é€£ç·š
            </div>
        </header>

        <div class="flex space-x-6 mb-6 px-2 text-sm text-slate-400 border-b">
            <button onclick="switchTab('hold')" id="tab-hold" class="pb-3 tab-active">æŒè‚¡åº«å­˜</button>
            <button onclick="switchTab('watch')" id="tab-watch" class="pb-3">è§€å¯Ÿåå–®</button>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <input id="in-id" type="text" placeholder="è‚¡ç¥¨ä»£è™Ÿ (å¦‚ 2330)" class="border border-slate-200 p-3 rounded-xl text-sm outline-none focus:border-blue-500 transition">
                <input id="in-qty" type="number" placeholder="æŒè‚¡å¼µæ•¸" class="border border-slate-200 p-3 rounded-xl text-sm outline-none">
                <input id="in-price" type="number" placeholder="è²·å…¥å–®åƒ¹" class="border border-slate-200 p-3 rounded-xl text-sm outline-none">
                <button onclick="handleAdd()" class="bg-blue-600 text-white rounded-xl font-bold text-sm py-3 hover:bg-blue-700 shadow-lg shadow-blue-100 transition">åŠ å…¥æ¸…å–®</button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <table class="w-full text-left text-sm">
                <thead class="bg-slate-50 border-b border-slate-100">
                    <tr class="text-slate-400 font-bold text-[11px] uppercase">
                        <th class="p-5">è‚¡ç¥¨æ¨™çš„</th>
                        <th class="p-5">æœ€æ–°ç¾åƒ¹</th>
                        <th class="p-5">æç›Š / ç‹€æ…‹</th>
                        <th class="p-5">ç­–ç•¥å»ºè­° (RSI)</th>
                        <th class="p-5 text-right">ç®¡ç†</th>
                    </tr>
                </thead>
                <tbody id="list-body" class="divide-y divide-slate-50">
                    </tbody>
            </table>
        </div>
        
        <footer class="mt-6 text-center">
            <p class="text-[10px] text-slate-300">æ•¸æ“šä¾†æºï¼šFinMind API | ç­–ç•¥é‚è¼¯ï¼šGoogle OPAL</p>
        </footer>
    </div>

    <script>
        // è€å¸«å·²å¹«ä½ å¡«å…¥ Token
        const MY_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNi0wMS0zMSAxMDo0NDo0MyIsInVzZXJfaWQiOiJoemg3NzY5IiwiZW1haWwiOiJoemg3NzY5QGdtYWlsLmNvbSIsImlwIjoiMS4xNjguMjE1LjgzIn0.-bUwxRYsIVslCKG5RZtjIRL50H1Oik4h_stpwslOX10";
        
        let currentTab = 'hold';
        let holdings = JSON.parse(localStorage.getItem('opal_holdings')) || [];
        let watchlist = JSON.parse(localStorage.getItem('opal_watch')) || [];

        async function fetchPrice(id) {
            try {
                const today = new Date().toISOString().split('T')[0];
                const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${today}&token=${MY_TOKEN}`;
                const res = await fetch(url);
                const json = await res.json();
                if (json.data && json.data.length > 0) {
                    return json.data[json.data.length - 1].close;
                }
            } catch (e) { console.error("æŠ“å–å¤±æ•—"); }
            return null;
        }

        async function handleAdd() {
            const id = document.getElementById('in-id').value.trim();
            const qty = parseFloat(document.getElementById('in-qty').value) || 0;
            const price = parseFloat(document.getElementById('in-price').value) || 0;

            if (!id) return alert("è«‹è¼¸å…¥ä»£è™Ÿ");

            // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            const btn = event.target;
            btn.innerText = "æŠ“å–ä¸­...";
            
            const livePrice = await fetchPrice(id);
            const newItem = { id, qty, buyPrice: price, live: livePrice || "ç„¡æ•¸æ“š" };

            if (currentTab === 'hold') holdings.push(newItem);
            else watchlist.push(newItem);

            save();
            render();
            btn.innerText = "åŠ å…¥æ¸…å–®";
            document.getElementById('in-id').value = "";
        }

        function render() {
            const list = currentTab === 'hold' ? holdings : watchlist;
            const body = document.getElementById('list-body');
            body.innerHTML = '';

            list.forEach((item, index) => {
                const pnl = (item.buyPrice > 0 && typeof item.live === 'number') 
                    ? (((item.live - item.buyPrice) / item.buyPrice) * 100).toFixed(2) 
                    : null;
                
                // æ¨¡æ“¬ RSIï¼Œå¾…ä¹‹å¾Œå¯¦ä½œ 14 å¤©æ•¸æ“šæŠ“å–
                const rsi = Math.floor(Math.random() * 50) + 15;

                body.innerHTML += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="p-5 font-bold text-slate-700">${item.id}</td>
                        <td class="p-5 font-mono text-blue-600">${item.live}</td>
                        <td class="p-5">
                            ${pnl !== null ? `<span class="${pnl >= 0 ? 'text-emerald-500' : 'text-rose-500'} font-bold">${pnl}%</span>` : '<span class="text-slate-300">ç›£æ§ä¸­</span>'}
                        </td>
                        <td class="p-5">
                            <span class="px-2 py-1 rounded-md text-[10px] font-bold ${rsi < 20 ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400'}">
                                ${rsi < 20 ? 'ğŸ”¥ åƒ¹å€¼è²·é»' : 'ğŸŸ¡ çºŒæŠ±'} (RSI:${rsi})
                            </span>
                        </td>
                        <td class="p-5 text-right">
                            <button onclick="remove(${index})" class="text-slate-200 hover:text-rose-400 transition"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-hold').className = tab === 'hold' ? 'pb-3 tab-active' : 'pb-3';
            document.getElementById('tab-watch').className = tab === 'watch' ? 'pb-3 tab-active' : 'pb-3';
            render();
        }

        function remove(i) {
            if (currentTab === 'hold') holdings.splice(i, 1);
            else watchlist.splice(i, 1);
            save(); render();
        }

        function save() {
            localStorage.setItem('opal_holdings', JSON.stringify(holdings));
            localStorage.setItem('opal_watch', JSON.stringify(watchlist));
        }

        render();
    </script>
</body>
</html>
