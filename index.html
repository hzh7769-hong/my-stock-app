<script>
    // --- æ ¸å¿ƒè¨˜æ†¶èˆ‡æ•¸æ“šå¼•æ“ ---
    let marketData = {
        "1513": { name: "ä¸­èˆˆé›»", price: 185.5, pe: 24.2, industryPe: 35.0, rsi: 22, chipDays: 4, ma20: 175 },
        "1519": { name: "è¯åŸ", price: 1015.0, pe: 72.5, industryPe: 35.0, rsi: 18, chipDays: 3, ma20: 980 },
        "2308": { name: "å°é”é›»", price: 420.0, pe: 28.5, industryPe: 32.0, rsi: 19, chipDays: 5, ma20: 400 }
    };

    // ã€æ–°å¢åŠŸèƒ½ã€‘å¾ç€è¦½å™¨è¨˜æ†¶é«”è®€å–è³‡æ–™
    let portfolio = JSON.parse(localStorage.getItem('myStockPortfolio')) || [];

    function saveToMemory() {
        localStorage.setItem('myStockPortfolio', JSON.stringify(portfolio));
    }

    function addStock() {
        const id = document.getElementById('stock-id').value;
        const qty = document.getElementById('stock-qty').value;
        const buyPrice = document.getElementById('stock-price').value;

        if (marketData[id]) {
            portfolio.push({ id, qty, buyPrice });
            saveToMemory(); // å„²å­˜åˆ°è¨˜æ†¶é«”
            renderPortfolio();
            updateChart();
        } else {
            alert("ç›®å‰æ¸¬è©¦ä»£ç¢¼æ”¯æ´ï¼š1513, 1519, 2308");
        }
    }

    // æ–°å¢ï¼šåˆªé™¤åº«å­˜çš„åŠŸèƒ½
    function removeStock(index) {
        portfolio.splice(index, 1);
        saveToMemory(); // æ›´æ–°è¨˜æ†¶é«”
        renderPortfolio();
        updateChart();
    }

    function renderPortfolio() {
        const body = document.getElementById('portfolio-body');
        body.innerHTML = '';

        portfolio.forEach((s, index) => {
            const liveData = marketData[s.id];
            const pnl = (((liveData.price - s.buyPrice) / s.buyPrice) * 100).toFixed(2);
            let advice = "ğŸŸ¡ çºŒæŠ±è§€å¯Ÿ";
            let adviceColor = "text-slate-400";

            if (pnl > 20 || liveData.price < liveData.ma20) {
                advice = "âš ï¸ å»ºè­°å‡ºå ´"; adviceColor = "text-rose-600 font-bold";
            } else if (liveData.rsi < 20 && liveData.pe < liveData.industryPe) {
                advice = "ğŸ”¥ å¼·åŠ›è²·é»"; adviceColor = "text-emerald-600 font-bold";
            }

            body.innerHTML += `
                <tr class="border-b">
                    <td class="py-4 font-bold">${s.id}</td>
                    <td class="py-4">${liveData.price}</td>
                    <td class="py-4 ${pnl >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${pnl}%</td>
                    <td class="py-4">${liveData.rsi}</td>
                    <td class="py-4 ${adviceColor}">${advice}</td>
                    <td class="py-4 text-right">
                        <button onclick="removeStock(${index})" class="text-slate-300 hover:text-rose-400"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    }

    // åˆå§‹åŒ–è‡ªå‹•åŸ·è¡Œ
    setInterval(() => {
        // æ¨¡æ“¬åƒ¹æ ¼éš¨æ©Ÿè·³å‹•é‚è¼¯åŒå‰...
        simulateMarket(); 
    }, 5000);
    
    // åˆå§‹è¼‰å…¥
    renderPortfolio();
    updateChart();
</script>
