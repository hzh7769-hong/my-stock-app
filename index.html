<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‚¡ç¥¨åƒ¹å€¼æŠ•è³‡ç­–ç•¥ v13.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #0f172a; }
        .tab-active { border-bottom: 4px solid #2563eb; color: #2563eb; font-weight: 900; }
        .card { background: white; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #f1f5f9; }
        .badge { padding: 0.35rem 0.75rem; border-radius: 0.5rem; font-weight: 900; font-size: 0.75rem; display: inline-block; min-width: 90px; text-align: center; }
        .pulse-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: #10b981; margin-right: 6px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        
        @media (max-width: 640px) {
            .mobile-hide { display: none; }
            .p-8 { padding: 1.25rem !important; }
            .text-4xl { font-size: 2rem; }
        }
    </style>
</head>
<body class="p-3 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <!-- æ¨™é¡Œèˆ‡ç‹€æ…‹ -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 px-2">
            <div>
                <h1 class="text-2xl md:text-3xl font-black text-slate-800 tracking-tighter">
                    è‚¡ç¥¨åƒ¹å€¼æŠ•è³‡ç­–ç•¥ 
                    <span class="text-xs align-top bg-blue-600 text-white px-2 py-0.5 rounded ml-1">v13.0 æ¥µé€Ÿç‰ˆ</span>
                </h1>
                <p id="system-msg" class="text-[10px] font-bold text-slate-400 mt-2 uppercase tracking-widest flex items-center">
                    <span class="w-2 h-2 bg-slate-300 rounded-full mr-2"></span> ç³»çµ±æº–å‚™ä¸­...
                </p>
            </div>
            <div class="mt-4 md:mt-0 flex gap-4">
                <span id="cache-status" class="text-[10px] font-bold text-slate-300 bg-slate-100 px-3 py-1 rounded-full">å¿«å–æª¢æŸ¥</span>
                <span id="cloud-status" class="text-[10px] font-bold text-slate-300 bg-slate-100 px-3 py-1 rounded-full">é›²ç«¯é€£ç·š</span>
            </div>
        </div>

        <!-- åˆ†é åˆ‡æ› -->
        <div class="flex space-x-8 mb-8 px-4 text-sm font-black text-slate-400 border-b-2 border-slate-100">
            <button onclick="switchTab('hold')" id="tab-hold" class="pb-3 tab-active transition-all hover:text-blue-500">æŒè‚¡åº«å­˜</button>
            <button onclick="switchTab('watch')" id="tab-watch" class="pb-3 transition-all hover:text-blue-500">è§€å¯Ÿåå–®</button>
        </div>

        <!-- å„€è¡¨æ¿å€åŸŸ (æŒè‚¡) -->
        <div id="dashboard-hold" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card p-6 flex flex-col items-center justify-center relative bg-gradient-to-br from-white to-blue-50/30">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-2">åº«å­˜æç›Šä½”æ¯”</p>
                <div class="w-32 h-32 relative">
                    <canvas id="winRateChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                        <span id="win-pct" class="text-2xl font-black text-slate-800">--%</span>
                    </div>
                </div>
            </div>
            <div class="md:col-span-2 card p-8 flex flex-col justify-center bg-white">
                <div class="flex flex-col md:flex-row justify-around items-center gap-8">
                    <div class="text-center md:text-left">
                        <p class="text-slate-400 text-[10px] font-black uppercase mb-1">ç¸½å¸‚å€¼ (TWD)</p>
                        <p id="total-mkt-val" class="text-4xl font-black text-slate-900 tracking-tight">$ 0</p>
                    </div>
                    <div class="text-center md:text-left border-t md:border-t-0 md:border-l-2 border-slate-100 pt-6 md:pt-0 md:pl-12">
                        <p class="text-slate-400 text-[10px] font-black uppercase mb-1">ç´¯ç©ç¸½ç›ˆè™§</p>
                        <p id="total-pnl-val" class="text-4xl font-black text-slate-300">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å„€è¡¨æ¿å€åŸŸ (è§€å¯Ÿ) -->
        <div id="dashboard-watch" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="card p-6 border-l-4 border-blue-500">
                <h3 class="text-sm font-black text-slate-800 mb-4 flex items-center"><i class="fa-solid fa-newspaper mr-2 text-blue-500"></i> æœ¬æ—¥é‡å¤§è²¡ç¶“æ–°è</h3>
                <ul class="space-y-3 text-xs font-bold text-slate-500">
                    <li><a href="https://news.cnyes.com/news/cat/tw_stock" target="_blank" class="hover:text-blue-600 transition-colors flex items-center justify-between">é‰…äº¨ç¶²å°è‚¡é ­æ¢ <i class="fa-solid fa-arrow-up-right-from-square text-[10px] opacity-50"></i></a></li>
                    <li><a href="https://tw.stock.yahoo.com/news/" target="_blank" class="hover:text-purple-600 transition-colors flex items-center justify-between">Yahoo è²¡ç¶“æ–°è <i class="fa-solid fa-arrow-up-right-from-square text-[10px] opacity-50"></i></a></li>
                    <li><a href="https://money.udn.com/money/index" target="_blank" class="hover:text-emerald-600 transition-colors flex items-center justify-between">ç¶“æ¿Ÿæ—¥å ±ç”¢æ¥­å‹•æ…‹ <i class="fa-solid fa-arrow-up-right-from-square text-[10px] opacity-50"></i></a></li>
                </ul>
            </div>
            <div class="card p-6 bg-slate-800 text-white">
                <h3 class="text-sm font-black text-blue-300 mb-4"><i class="fa-solid fa-robot mr-2"></i> AI è¶¨å‹¢åˆ¤è®€é‚è¼¯</h3>
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div>
                        <p class="text-slate-400 uppercase mb-2">å¤šç©ºè¨Šè™Ÿ</p>
                        <ul class="space-y-1 text-slate-300">
                            <li>ğŸ“ˆ <span class="text-emerald-400">å¤šé ­</span>: åƒ¹ > æœˆç·š > å­£ç·š</li>
                            <li>ğŸ“‰ <span class="text-rose-400">ç©ºé ­</span>: åƒ¹ < æœˆç·š < å­£ç·š</li>
                            <li>ğŸš€ <span class="text-blue-400">ç¿»æš</span>: é»ƒé‡‘äº¤å‰ + å­£ç·šå¹³</li>
                        </ul>
                    </div>
                    <div>
                        <p class="text-slate-400 uppercase mb-2">è§€å¯Ÿé‡é»</p>
                        <p class="text-slate-300 leading-relaxed">
                            ç³»çµ±è‡ªå‹•è¨˜éŒ„ã€ŒåŠ å…¥è§€å¯Ÿæ™‚ã€çš„è‚¡åƒ¹ï¼Œè¿½è¹¤è‡³ä»Šçš„æ¼²è·Œå¹…ï¼Œä¸¦è‡ªå‹•æ¨ç®—ç›®æ¨™åƒ¹ã€‚
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¼¸å…¥å€ -->
        <div class="card p-6 mb-8 border border-blue-50">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">è‚¡ç¥¨ä»£è™Ÿ</label>
                    <input id="in-id" type="text" placeholder="2330" class="w-full border-2 border-slate-100 p-3 rounded-xl font-bold focus:border-blue-500 outline-none transition-colors">
                </div>
                
                <!-- æŒè‚¡æ¬„ä½ -->
                <div class="hold-field md:col-span-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">æŒè‚¡å¼µæ•¸</label>
                    <input id="in-qty" type="number" placeholder="1" class="w-full border-2 border-slate-100 p-3 rounded-xl font-bold outline-none">
                </div>
                <div class="hold-field md:col-span-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">å¹³å‡æˆæœ¬</label>
                    <input id="in-price" type="number" placeholder="0.0" class="w-full border-2 border-slate-100 p-3 rounded-xl font-bold outline-none">
                </div>

                <!-- è§€å¯Ÿæ¬„ä½ (ç°¡åŒ–ï¼šåªéœ€ä»£è™Ÿ) -->
                <div class="watch-field hidden md:col-span-2 flex items-center">
                    <p class="text-xs text-slate-400 font-bold bg-slate-100 px-4 py-2 rounded-lg w-full">
                        <i class="fa-solid fa-wand-magic-sparkles text-blue-500 mr-2"></i>
                        ç³»çµ±å°‡è‡ªå‹•æŠ“å–ã€Œç›®å‰è‚¡åƒ¹ã€ä½œç‚ºèµ·å§‹è§€å¯Ÿé»
                    </p>
                </div>
                
                <div class="md:col-span-1 flex items-end">
                    <button id="add-btn" onclick="handleAdd()" class="w-full bg-slate-900 text-white rounded-xl font-black py-3.5 uppercase hover:bg-blue-600 transition-all shadow-lg active:scale-95 text-xs tracking-widest">
                        åŸ·è¡Œæ–°å¢
                    </button>
                </div>
            </div>
        </div>

        <!-- åˆ—è¡¨å€åŸŸ -->
        <div class="card overflow-x-auto min-h-[300px]">
            <table class="w-full text-left min-w-[1000px]">
                <thead class="bg-slate-50 border-b border-slate-100">
                    <tr id="table-head" class="text-slate-400 font-black text-[10px] uppercase tracking-widest"></tr>
                </thead>
                <tbody id="list-body" class="divide-y divide-slate-50"></tbody>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://ssfjjxodayazqvkughev.supabase.co";
        const SUPABASE_KEY = "sb_publishable_XxIhEbw9nVyc3Qr9tkY7qw_deXnd33I";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const FINMIND_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNi0wMS0zMSAxMDo0NDo0MyIsInVzZXJfaWQiOiJoemg3NzY5IiwiZW1haWwiOiJoemg3NzY5QGdtYWlsLmNvbSIsImlwIjoiMS4xNjguMjE1LjgzIn0.-bUwxRYsIVslCKG5RZtjIRL50H1Oik4h_stpwslOX10";

        let currentTab = 'hold', stockDB = {}, allData = [], chartInstance = null;

        // --- 1. æ¥µé€Ÿåˆå§‹åŒ– (å¿«å–å„ªåŒ–) ---
        async function init() {
            try {
                // æª¢æŸ¥ LocalStorage æ˜¯å¦æœ‰åç¨±å¿«å–
                const cachedNames = localStorage.getItem('stock_names_cache');
                if (cachedNames) {
                    stockDB = JSON.parse(cachedNames);
                    document.getElementById('cache-status').innerHTML = '<span class="text-emerald-500">â—</span> å¿«å–è¼‰å…¥';
                } else {
                    document.getElementById('system-msg').innerHTML = '<span class="w-2 h-2 bg-yellow-400 rounded-full mr-2 animate-pulse"></span> ä¸‹è¼‰ä»£è™Ÿåº«...';
                    fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockInfo&token=${FINMIND_TOKEN}`)
                        .then(r => r.json())
                        .then(json => {
                            json.data.forEach(s => stockDB[s.stock_id] = s.stock_name);
                            localStorage.setItem('stock_names_cache', JSON.stringify(stockDB));
                            document.getElementById('cache-status').innerHTML = '<span class="text-emerald-500">â—</span> å»ºç«‹å¿«å–';
                        });
                }

                // åŒæ­¥æŠ“å–é›²ç«¯è³‡æ–™
                await fetchFromCloud();
                document.getElementById('cloud-status').innerHTML = '<span class="text-emerald-500">â—</span> é›²ç«¯é€£ç·š';
                document.getElementById('system-msg').innerHTML = '<span class="text-emerald-500">â—</span> ç³»çµ±å°±ç·’';
            } catch (e) { 
                console.error("Init Error:", e);
                document.getElementById('system-msg').innerText = "é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
            }
        }

        async function fetchFromCloud() {
            const { data, error } = await _supabase.from('user_holdings').select('*').order('id', { ascending: true }); // æŒ‰åŠ å…¥é †åºæ’
            if (!error) {
                allData = data || [];
                render();
            }
        }

        // --- 2. æ ¸å¿ƒé‹ç®—ï¼šè¶¨å‹¢èˆ‡ä¼°å€¼ ---
        async function analyzeStock(id) {
            const today = new Date();
            const past180 = new Date(); past180.setDate(today.getDate() - 180); 
            const past700 = new Date(); past700.setDate(today.getDate() - 750); 
            
            const startK = past180.toISOString().split('T')[0];
            const startF = past700.toISOString().split('T')[0];

            try {
                const [priceRes, epsRes, instRes, perRes] = await Promise.all([
                    fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${startK}&token=${FINMIND_TOKEN}`).then(r => r.json()),
                    fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockFinancialStatements&data_id=${id}&start_date=${startF}&token=${FINMIND_TOKEN}`).then(r => r.json()),
                    fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockInstitutionalInvestorsBuySell&data_id=${id}&start_date=${startK}&token=${FINMIND_TOKEN}`).then(r => r.json()),
                    fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPER&data_id=${id}&start_date=${startK}&token=${FINMIND_TOKEN}`).then(r => r.json())
                ]);

                const prices = priceRes.data || [];
                if (prices.length === 0) return null;

                const latest = prices[prices.length - 1];
                const closePrices = prices.map(p => p.close);
                const volumes = prices.map(p => p.Trading_Volume);

                // æŠ€è¡“æŒ‡æ¨™
                const ma5 = calculateMA(closePrices, 5);
                const ma20 = calculateMA(closePrices, 20);
                const ma60 = calculateMA(closePrices, 60);
                const rsi6 = calculateRSI(closePrices, 6);
                const avgVol5 = calculateMA(volumes, 5);
                
                // è¶¨å‹¢åˆ¤æ–· (å¤š/ç©º/ç›¤)
                let trend = 'ç›¤æ•´';
                let trendClass = 'text-slate-400';
                if (latest.close > ma20 && ma20 > ma60) {
                    trend = 'å¤šé ­æ’åˆ— ğŸ“ˆ'; trendClass = 'text-emerald-500 font-black';
                } else if (latest.close < ma20 && ma20 < ma60) {
                    trend = 'ç©ºé ­æ’åˆ— ğŸ“‰'; trendClass = 'text-rose-500 font-black';
                } else if (ma5 > ma20 && ma20 < ma60) {
                    trend = 'åº•éƒ¨ç¿»æš ğŸš€'; trendClass = 'text-blue-500 font-black';
                }

                // ç±Œç¢¼é¢
                const foreignData = (instRes.data || []).filter(d => d.name === 'Foreign_Investor');
                const foreign3Day = foreignData.slice(-3).reduce((acc, cur) => acc + cur.buy - cur.sell, 0) / 1000;

                // åŸºæœ¬é¢
                const epsList = (epsRes.data || []).filter(d => d.type === 'EPS').sort((a,b) => new Date(a.date) - new Date(b.date));
                const epsTTM = epsList.slice(-4).reduce((acc, cur) => acc + cur.value, 0).toFixed(2);
                
                // æˆé•·ç‡
                let growthRate = null;
                if(epsList.length >= 5) {
                    const lastQ = epsList[epsList.length-1].value;
                    const prevQ = epsList[epsList.length-5].value;
                    if(prevQ !== 0) growthRate = ((lastQ - prevQ) / Math.abs(prevQ) * 100).toFixed(1);
                }

                // AI åˆç† PE
                const perList = (perRes.data || []).map(d => d.PER).filter(p => p > 0);
                const avgPER = perList.length > 0 ? (perList.reduce((a,b)=>a+b,0)/perList.length) : 15;
                let aiPE = avgPER;
                if (growthRate && growthRate > 15) aiPE = Math.min(avgPER * 1.25, 35); 
                else if (growthRate && growthRate < -5) aiPE = Math.max(avgPER * 0.8, 10);
                
                return {
                    live: latest.close,
                    trend, trendClass,
                    ma20, rsi: rsi6,
                    eps: epsTTM,
                    growth: growthRate,
                    aiPE: aiPE.toFixed(1),
                    avgVol: avgVol5,
                    foreign3Day: foreign3Day,
                    open: latest.open
                };
            } catch (e) { return null; }
        }

        function calculateMA(data, days) {
            if (data.length < days) return 0;
            return data.slice(-days).reduce((a, b) => a + b, 0) / days;
        }

        function calculateRSI(prices, period) {
            if (prices.length < period + 1) return 50;
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const diff = prices[i] - prices[i - 1];
                if (diff >= 0) gains += diff; else losses -= diff;
            }
            const rs = losses === 0 ? 100 : gains / losses;
            return 100 - (100 / (1 + rs));
        }

        // --- æ¸²æŸ“ç•«é¢ ---
        async function render() {
            const body = document.getElementById('list-body');
            const head = document.getElementById('table-head');
            body.innerHTML = '<tr><td colspan="7" class="p-10 text-center text-slate-400 font-bold animate-pulse text-xs tracking-widest">AI é‹ç®—åˆ†æä¸­...</td></tr>';
            
            let totalMkt = 0, totalCost = 0, winCount = 0, lossCount = 0;
            const filtered = allData.filter(d => currentTab === 'hold' ? d.buy_price > 0 : d.buy_price === 0);

            if (currentTab === 'hold') {
                head.innerHTML = '<th class="p-5">æ¨™çš„/ç¾åƒ¹</th><th class="p-5">æˆæœ¬/å¸‚å€¼</th><th class="p-5 text-center">æç›Šè©¦ç®—</th><th class="p-5">AIä¼°å€¼ (EPSÃ—PE)</th><th class="p-5 text-center">AI æ±ºç­–å»ºè­°</th><th class="p-5 text-right">ç®¡ç†</th>';
            } else {
                head.innerHTML = '<th class="p-5">è§€å¯Ÿæ¨™çš„</th><th class="p-5">èµ·å§‹ / ç¾åƒ¹</th><th class="p-5">ç›®æ¨™åƒ¹ (Auto)</th><th class="p-5">è¶¨å‹¢ä¿¡è™Ÿ</th><th class="p-5 text-center">ç‹€æ…‹</th><th class="p-5 text-right">ç®¡ç†</th>';
            }

            const rows = [];
            
            for (let item of filtered) {
                const data = await analyzeStock(item.stock_id);
                const name = stockDB[item.stock_id] || "";
                if (!data) continue;

                const linkHtml = `<a href="https://tw.stock.yahoo.com/quote/${item.stock_id}" target="_blank" class="hover:text-blue-600 font-black text-slate-800 text-lg decoration-blue-500 underline-offset-4">${item.stock_id} ${name}</a>`;

                if (currentTab === 'hold') {
                    // --- æŒè‚¡ç­–ç•¥ ---
                    const targetPrice = (data.eps * data.aiPE).toFixed(1);
                    const pnlPct = (((data.live - item.buy_price)/item.buy_price)*100).toFixed(2);
                    const pnlAmt = Math.round((data.live - item.buy_price) * item.qty * 1000); 
                    
                    const isDropMA20 = data.live < data.ma20;
                    
                    let advice = 'ğŸŸ¡ çºŒæŠ±';
                    let badgeClass = 'bg-slate-100 text-slate-500';

                    if (isDropMA20) {
                        advice = 'ğŸ›‘ ç ´ç·šè³£å‡º'; badgeClass = 'bg-rose-500 text-white shadow-lg shadow-rose-200';
                    } else if (parseFloat(targetPrice) > 0 && data.live >= parseFloat(targetPrice)) {
                        advice = 'ğŸ’° ç²åˆ©é”æ¨™'; badgeClass = 'bg-emerald-500 text-white shadow-lg shadow-emerald-200';
                    }

                    totalMkt += data.live * item.qty * 1000;
                    totalCost += item.buy_price * item.qty * 1000;
                    if (data.live >= item.buy_price) winCount++; else lossCount++;

                    rows.push(`
                        <tr class="hover:bg-slate-50 border-b border-slate-100 group">
                            <td class="p-5">${linkHtml}<br><span class="text-blue-600 font-bold font-mono text-xl">${data.live}</span></td>
                            <td class="p-5">
                                <span class="text-xs text-slate-400 font-bold uppercase">æˆæœ¬: ${item.buy_price}</span><br>
                                <span class="text-xs text-slate-400 font-bold uppercase">å¼µæ•¸: ${item.qty}</span>
                            </td>
                            <td class="p-5 text-center bg-slate-50/50">
                                <span class="font-black ${pnlPct>=0?'text-emerald-500':'text-rose-500'} text-xl">${pnlPct}%</span><br>
                                <span class="text-xs font-bold ${pnlAmt>=0?'text-emerald-600':'text-rose-600'}">${pnlAmt>0?'+':''}$${pnlAmt.toLocaleString()}</span>
                            </td>
                            <td class="p-5">
                                <span class="text-xs text-slate-400 font-bold">EPS:${data.eps} Ã— PE:${data.aiPE}</span><br>
                                <span class="font-black text-slate-700 text-lg">Target: ${targetPrice > 0 ? targetPrice : '--'}</span>
                            </td>
                            <td class="p-5 text-center"><span class="badge ${badgeClass}">${advice}</span></td>
                            <td class="p-5 text-right"><button onclick="remove(${item.id})" class="text-slate-200 hover:text-rose-500 transition-colors"><i class="fa-solid fa-trash-can text-lg"></i></button></td>
                        </tr>
                    `);

                } else {
                    // --- è§€å¯Ÿç­–ç•¥ (æ™ºæ…§é€²åŒ–) ---
                    // 1. è‡ªå‹•ç›®æ¨™åƒ¹
                    const autoTarget = (data.eps * data.aiPE).toFixed(1);
                    
                    // 2. èµ·å§‹ç´€éŒ„ (è³‡æ–™åº«çš„ buy_price å­˜èµ·å§‹åƒ¹, qty å­˜ 0)
                    // å¦‚æœ buy_price ç‚º 0 (èˆŠè³‡æ–™)ï¼Œé¡¯ç¤º --
                    const startPrice = item.buy_price > 0 ? item.buy_price : data.live; // è‹¥ç„¡ç´€éŒ„å‰‡è¦–ç‚ºç•¶ä¸‹
                    const trackPnl = (((data.live - startPrice)/startPrice)*100).toFixed(1);
                    const trackColor = trackPnl >= 0 ? 'text-emerald-500' : 'text-rose-500';

                    // 3. ç‹€æ…‹åˆ¤æ–·
                    let status = 'è§€å¯Ÿä¸­';
                    let statusClass = 'bg-slate-100 text-slate-400';
                    if(data.live >= autoTarget && autoTarget > 0) {
                        status = 'âœ¨ å·²é”æ¨™'; statusClass = 'bg-emerald-100 text-emerald-600';
                    }

                    rows.push(`
                        <tr class="hover:bg-slate-50 border-b border-slate-100">
                            <td class="p-5">${linkHtml}</td>
                            <td class="p-5">
                                <span class="text-xs text-slate-400 font-bold">èµ·å§‹: ${startPrice}</span><br>
                                <span class="text-blue-600 font-bold font-mono text-lg">${data.live}</span>
                                <span class="text-xs font-bold ${trackColor} ml-2">(${trackPnl}%)</span>
                            </td>
                            <td class="p-5">
                                <span class="font-black text-slate-700 text-lg">${autoTarget > 0 ? autoTarget : '--'}</span><br>
                                <span class="text-[10px] text-slate-400">EPS:${data.eps} Ã— PE:${data.aiPE}</span>
                            </td>
                            <td class="p-5">
                                <span class="${data.trendClass} text-sm">${data.trend}</span><br>
                                <span class="text-[10px] text-slate-400">RSI: ${data.rsi.toFixed(1)}</span>
                            </td>
                            <td class="p-5 text-center"><span class="badge ${statusClass}">${status}</span></td>
                            <td class="p-5 text-right"><button onclick="remove(${item.id})" class="text-slate-300 hover:text-rose-500"><i class="fa-solid fa-trash-can"></i></button></td>
                        </tr>
                    `);
                }
            }
            body.innerHTML = rows.join('');
            
            if (currentTab === 'hold') {
                const diff = totalMkt - totalCost;
                const diffPct = totalCost > 0 ? ((diff/totalCost)*100).toFixed(2) : 0;
                document.getElementById('total-mkt-val').innerText = `$ ${Math.round(totalMkt).toLocaleString()}`;
                document.getElementById('total-pnl-val').innerText = `${diff >= 0 ? '+' : ''}${Math.round(diff).toLocaleString()} (${diffPct}%)`;
                document.getElementById('total-pnl-val').className = `text-3xl md:text-4xl font-black ${diff >= 0 ? 'text-emerald-500' : 'text-rose-500'}`;
                updateChart(winCount, lossCount);
            }
        }

        async function handleAdd() {
            const id = document.getElementById('in-id').value.trim();
            if (!id) return;
            const btn = document.getElementById('add-btn');
            btn.innerText = "é›²ç«¯åŒæ­¥ä¸­...";
            
            const qty = currentTab === 'hold' ? (parseFloat(document.getElementById('in-qty').value) || 0) : 0;
            let price = 0;

            if (currentTab === 'hold') {
                price = parseFloat(document.getElementById('in-price').value) || 0; 
            } else {
                // è§€å¯Ÿåå–®ï¼šè‡ªå‹•æŠ“å–ç•¶å‰è‚¡åƒ¹ä½œç‚ºã€Œèµ·å§‹è§€å¯Ÿåƒ¹ã€
                const live = await getLivePrice(id);
                price = live || 0;
            }

            const { error } = await _supabase.from('user_holdings').insert([{ stock_id: id, qty: qty, buy_price: price }]);
            
            if (!error) { await fetchFromCloud(); document.querySelectorAll('input').forEach(i => i.value = ""); }
            btn.innerText = currentTab === 'hold' ? "æ–°å¢æŒè‚¡" : "æ–°å¢è§€å¯Ÿ";
        }

        async function getLivePrice(id) {
            try {
                const res = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=2026-01-20&token=${FINMIND_TOKEN}`);
                const json = await res.json();
                return json.data?.length > 0 ? json.data[json.data.length - 1].close : null;
            } catch (e) { return null; }
        }

        async function remove(id) {
            if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                await _supabase.from('user_holdings').delete().eq('id', id);
                await fetchFromCloud();
            }
        }

        function switchTab(t) {
            currentTab = t;
            document.getElementById('tab-hold').className = t === 'hold' ? 'pb-3 tab-active' : 'pb-3';
            document.getElementById('tab-watch').className = t === 'watch' ? 'pb-3 tab-active' : 'pb-3';
            
            document.getElementById('dashboard-hold').style.display = t === 'hold' ? 'grid' : 'none';
            document.getElementById('dashboard-watch').style.display = t === 'watch' ? 'grid' : 'none';
            document.querySelectorAll('.hold-field').forEach(e => e.style.display = t === 'hold' ? 'block' : 'none');
            document.querySelectorAll('.watch-field').forEach(e => e.style.display = t === 'watch' ? 'block' : 'none');
            
            document.getElementById('add-btn').innerText = t === 'hold' ? "æ–°å¢æŒè‚¡" : "æ–°å¢è§€å¯Ÿ";
            render();
        }

        function updateChart(win, loss) {
            const ctx = document.getElementById('winRateChart').getContext('2d');
            const total = win + loss;
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { datasets: [{ data: total? [win, loss] : [1], backgroundColor: total? ['#10b981', '#cbd5e1'] : ['#f1f5f9'], borderWidth: 0, borderRadius: 20 }] },
                options: { cutout: '85%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            document.getElementById('win-pct').innerText = total ? Math.round((win/total)*100) + '%' : '--%';
        }

        init();
    </script>
</body>
</html>
